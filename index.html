<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Detector de Billetes MX - ESP32-CAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .pulse-success {
            animation: pulse 0.5s ease-out;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
        }
        .barra-confianza {
            transition: width 0.2s ease-out;
        }
        .resultado-flash {
            animation: flash-in 0.3s ease-out;
        }
        @keyframes flash-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .connecting {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="text-white">
    
    <div class="container mx-auto px-4 py-4 max-w-lg">
        
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent">
                üíµ Detector de Billetes MX
            </h1>
            <p class="text-slate-400 text-sm">ESP32-CAM + Inteligencia Artificial</p>
        </header>
        
        <!-- Configuraci√≥n -->
        <div class="glass rounded-xl p-4 mb-4" id="config-panel">
            <h2 class="text-sm font-bold text-slate-400 mb-3">‚öôÔ∏è Configuraci√≥n</h2>
            
            <!-- IP del ESP32-CAM -->
            <div class="mb-3">
                <label class="text-xs text-slate-500">IP del ESP32-CAM:</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="esp32-ip" 
                           placeholder="192.168.1.100"
                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                    <button onclick="probarConexion()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        Probar
                    </button>
                </div>
                <p id="estado-esp32" class="text-xs text-slate-500 mt-1">No conectado</p>
            </div>
            
            <!-- URL del modelo -->
            <div class="mb-3">
                <label class="text-xs text-slate-500">URL del modelo Teachable Machine:</label>
                <input type="text" id="model-url" 
                       value="https://teachablemachine.withgoogle.com/models/jWNHKAxkP/"
                       class="w-full mt-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
            </div>
            
            <button onclick="iniciarSistema()" id="btn-iniciar"
                    class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-bold transition-all">
                üöÄ Conectar e Iniciar
            </button>
        </div>
        
        <!-- Panel principal (oculto hasta conectar) -->
        <div id="main-panel" class="hidden">
            
            <!-- Vista de c√°mara -->
            <div class="glass rounded-xl p-3 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-slate-400">üì∑ ESP32-CAM</span>
                    <div class="flex items-center gap-2">
                        <div id="estado-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span id="estado-text" class="text-xs text-slate-400">Conectado</span>
                    </div>
                </div>
                <div class="relative bg-black rounded-lg overflow-hidden" style="aspect-ratio: 4/3;">
                    <img id="camera-feed" class="w-full h-full object-contain" alt="C√°mara ESP32">
                    <canvas id="canvas-proceso" class="hidden"></canvas>
                </div>
                
                <!-- Controles de c√°mara -->
                <div class="flex gap-2 mt-2">
                    <button onclick="toggleFlash()" id="btn-flash"
                            class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        üí° Flash OFF
                    </button>
                    <button onclick="capturarYAnalizar()" id="btn-capturar"
                            class="flex-1 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-bold">
                        üì∏ Detectar
                    </button>
                </div>
            </div>
            
            <!-- Resultado -->
            <div class="glass rounded-xl p-6 mb-4" id="panel-resultado">
                <div id="resultado-contenido" class="text-center">
                    <div class="text-5xl mb-3">üíµ</div>
                    <p class="text-slate-400">Presiona "Detectar" para analizar</p>
                </div>
            </div>
            
            <!-- Barras de confianza -->
            <div class="glass rounded-xl p-4 mb-4">
                <h3 class="text-sm font-bold text-slate-400 mb-3">üìä Probabilidades</h3>
                <div id="barras-container" class="space-y-2"></div>
            </div>
            
            <!-- Historial y Total -->
            <div class="grid grid-cols-2 gap-3">
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xs font-bold text-slate-400 mb-2">Historial</h3>
                    <div id="historial" class="space-y-1 max-h-24 overflow-y-auto text-sm">
                        <p class="text-slate-600 text-xs">Sin detecciones</p>
                    </div>
                </div>
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xs font-bold text-slate-400 mb-2">Total</h3>
                    <div class="text-2xl font-bold text-emerald-400" id="total">$0</div>
                    <button onclick="resetTotal()" class="text-xs text-slate-500 hover:text-slate-400 mt-1">üîÑ Reset</button>
                </div>
            </div>
            
            <!-- Modo autom√°tico -->
            <div class="glass rounded-xl p-4 mt-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-slate-300">üîÑ Modo Autom√°tico</h3>
                        <p class="text-xs text-slate-500">Detecta continuamente cada 2 segundos</p>
                    </div>
                    <button onclick="toggleModoAuto()" id="btn-auto"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        OFF
                    </button>
                </div>
            </div>
            
            <!-- Audio -->
            <div class="flex gap-3 mt-4">
                <button onclick="toggleAudio()" id="btn-audio"
                        class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold">
                    üîä Audio ON
                </button>
            </div>
        </div>
    </div>
    
    <script>
    // ============================================
    // CONFIGURACI√ìN
    // ============================================
    const CONFIG = {
        umbralConfianza: 0.80,
        confirmacionesRequeridas: 2,
        tiempoMaxConfirmacion: 3000,
        cooldownDeteccion: 2000,
        intervaloAuto: 2000,
        
        coloresBilletes: {
            20: { color: '#3b82f6', nombre: 'veinte' },
            50: { color: '#ec4899', nombre: 'cincuenta' },
            100: { color: '#f97316', nombre: 'cien' },
            200: { color: '#22c55e', nombre: 'doscientos' },
            500: { color: '#06b6d4', nombre: 'quinientos' },
            1000: { color: '#a855f7', nombre: 'mil' }
        }
    };
    
    // ============================================
    // ESTADO
    // ============================================
    let esp32Ip = '';
    let model = null;
    let clasesModelo = {};
    let flashEncendido = false;
    let audioHabilitado = true;
    let modoAutoActivo = false;
    let intervaloAuto = null;
    let ultimaDeteccion = 0;
    let confirmaciones = [];
    let historial = [];
    let totalAcumulado = 0;
    let analizando = false;
    
    // ============================================
    // CONEXI√ìN ESP32-CAM
    // ============================================
    async function probarConexion() {
        const ip = document.getElementById('esp32-ip').value.trim();
        if (!ip) {
            alert('Ingresa la IP del ESP32-CAM');
            return;
        }
        
        const estado = document.getElementById('estado-esp32');
        estado.textContent = 'üîÑ Probando conexi√≥n...';
        estado.className = 'text-xs text-yellow-500 mt-1 connecting';
        
        // Usar imagen para probar (evita CORS)
        const testImg = new Image();
        testImg.onload = function() {
            estado.textContent = '‚úÖ ESP32-CAM conectado!';
            estado.className = 'text-xs text-green-500 mt-1';
            esp32Ip = ip;
        };
        testImg.onerror = function() {
            estado.textContent = '‚ùå No se pudo conectar. Verifica la IP.';
            estado.className = 'text-xs text-red-500 mt-1';
        };
        testImg.src = `http://${ip}/captura?t=${Date.now()}`;
    }
    
    // ============================================
    // INICIAR SISTEMA
    // ============================================
    async function iniciarSistema() {
        const ip = document.getElementById('esp32-ip').value.trim();
        const modelUrl = document.getElementById('model-url').value.trim();
        
        if (!ip) {
            alert('Ingresa la IP del ESP32-CAM');
            return;
        }
        
        if (!modelUrl) {
            alert('Ingresa la URL del modelo');
            return;
        }
        
        const btn = document.getElementById('btn-iniciar');
        btn.disabled = true;
        btn.textContent = '‚è≥ Conectando al ESP32...';
        
        // Probar ESP32 con imagen (evita CORS)
        const testOk = await new Promise((resolve) => {
            const testImg = new Image();
            testImg.onload = () => resolve(true);
            testImg.onerror = () => resolve(false);
            testImg.src = `http://${ip}/captura?t=${Date.now()}`;
            
            // Timeout de 5 segundos
            setTimeout(() => resolve(false), 5000);
        });
        
        if (!testOk) {
            alert('No se pudo conectar al ESP32-CAM.\n\nVerifica:\n1. La IP es correcta\n2. Est√°s en la misma red WiFi\n3. El ESP32 est√° encendido');
            btn.disabled = false;
            btn.textContent = 'üöÄ Conectar e Iniciar';
            return;
        }
        
        esp32Ip = ip;
        
        try {
            // Cargar modelo
            btn.textContent = '‚è≥ Cargando modelo IA...';
            const url = modelUrl.endsWith('/') ? modelUrl : modelUrl + '/';
            model = await tmImage.load(url + 'model.json', url + 'metadata.json');
            
            const labels = model.getClassLabels();
            console.log('Modelo cargado. Clases:', labels);
            
            // Mapear clases
            clasesModelo = {};
            for (const label of labels) {
                clasesModelo[label] = extraerValorDeClase(label);
            }
            
            // Crear barras
            crearBarrasConfianza(labels);
            
            // Mostrar panel principal
            document.getElementById('config-panel').classList.add('hidden');
            document.getElementById('main-panel').classList.remove('hidden');
            
            // Mostrar primera imagen
            actualizarImagen();
            
            hablar('Sistema listo. Presiona detectar para analizar un billete.');
            
        } catch (e) {
            console.error(e);
            alert('Error cargando modelo: ' + e.message);
            btn.disabled = false;
            btn.textContent = 'üöÄ Conectar e Iniciar';
        }
    }
    
    function extraerValorDeClase(nombre) {
        const match = nombre.match(/(\d+)/);
        if (match) {
            const num = parseInt(match[1]);
            if ([20, 50, 100, 200, 500, 1000].includes(num)) return num;
        }
        return 0;
    }
    
    // ============================================
    // IMAGEN DEL ESP32
    // ============================================
    async function actualizarImagen() {
        if (!esp32Ip) return;
        
        const img = document.getElementById('camera-feed');
        img.src = `http://${esp32Ip}/captura?t=${Date.now()}`;
    }
    
    // ============================================
    // CAPTURA Y AN√ÅLISIS
    // ============================================
    async function capturarYAnalizar() {
        if (!model || !esp32Ip || analizando) return;
        
        const now = Date.now();
        if ((now - ultimaDeteccion) < CONFIG.cooldownDeteccion && !modoAutoActivo) {
            return;
        }
        
        analizando = true;
        const btn = document.getElementById('btn-capturar');
        btn.disabled = true;
        btn.textContent = '‚è≥ Analizando...';
        
        try {
            // Obtener imagen fresca
            const imgUrl = `http://${esp32Ip}/captura?t=${Date.now()}`;
            
            // Crear imagen temporal para an√°lisis
            const img = new Image();
            img.crossOrigin = 'anonymous';  // Importante para CORS
            
            const imgLoaded = await new Promise((resolve) => {
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = imgUrl;
                setTimeout(() => resolve(false), 5000);
            });
            
            if (!imgLoaded) {
                throw new Error('No se pudo cargar la imagen');
            }
            
            // Actualizar vista
            document.getElementById('camera-feed').src = imgUrl;
            
            // Analizar con el modelo
            const predictions = await model.predict(img);
            
            // Actualizar barras
            actualizarBarras(predictions);
            
            // Encontrar mejor
            let mejor = predictions.reduce((a, b) => 
                a.probability > b.probability ? a : b
            );
            
            const valor = clasesModelo[mejor.className] || 0;
            
            if (valor > 0 && mejor.probability >= CONFIG.umbralConfianza) {
                agregarConfirmacion(valor, mejor.probability);
            } else if (valor === 0 && mejor.probability >= 0.7) {
                // Es "nada" con buena confianza
                document.getElementById('resultado-contenido').innerHTML = `
                    <div class="text-4xl mb-3">üîç</div>
                    <p class="text-slate-400">No se detect√≥ billete</p>
                    <p class="text-xs text-slate-500 mt-2">Confianza: ${Math.round(mejor.probability * 100)}%</p>
                `;
            } else {
                document.getElementById('resultado-contenido').innerHTML = `
                    <div class="text-4xl mb-3">‚ùì</div>
                    <p class="text-amber-400">No estoy seguro...</p>
                    <p class="text-xs text-slate-500 mt-2">Intenta de nuevo</p>
                `;
            }
            
        } catch (e) {
            console.error('Error analizando:', e);
            document.getElementById('resultado-contenido').innerHTML = `
                <div class="text-4xl mb-3">‚ö†Ô∏è</div>
                <p class="text-red-400">Error de conexi√≥n</p>
                <p class="text-xs text-slate-500 mt-2">Verifica el ESP32-CAM</p>
            `;
        }
        
        btn.disabled = false;
        btn.textContent = 'üì∏ Detectar';
        analizando = false;
    }
    
    // ============================================
    // BARRAS DE CONFIANZA
    // ============================================
    function crearBarrasConfianza(labels) {
        const container = document.getElementById('barras-container');
        container.innerHTML = labels.map(label => {
            const valor = clasesModelo[label] || 0;
            const colorInfo = CONFIG.coloresBilletes[valor] || { color: '#64748b' };
            const displayName = valor > 0 ? `$${valor}` : 'Nada';
            return `
                <div class="flex items-center gap-2">
                    <span class="text-xs w-12 text-right">${displayName}</span>
                    <div class="flex-1 bg-slate-700 rounded-full h-3">
                        <div id="barra-${label.replace(/\s+/g, '_')}" class="barra-confianza h-3 rounded-full" 
                             style="width: 0%; background-color: ${colorInfo.color}"></div>
                    </div>
                    <span id="pct-${label.replace(/\s+/g, '_')}" class="text-xs w-10 text-slate-400">0%</span>
                </div>
            `;
        }).join('');
    }
    
    function actualizarBarras(predictions) {
        for (const pred of predictions) {
            const safeId = pred.className.replace(/\s+/g, '_');
            const barra = document.getElementById('barra-' + safeId);
            const pct = document.getElementById('pct-' + safeId);
            if (barra && pct) {
                const porcentaje = Math.round(pred.probability * 100);
                barra.style.width = porcentaje + '%';
                pct.textContent = porcentaje + '%';
            }
        }
    }
    
    // ============================================
    // CONFIRMACIONES
    // ============================================
    function agregarConfirmacion(valor, confianza) {
        const ahora = Date.now();
        
        confirmaciones = confirmaciones.filter(c => 
            ahora - c.timestamp < CONFIG.tiempoMaxConfirmacion &&
            c.valor === valor
        );
        
        confirmaciones.push({ valor, confianza, timestamp: ahora });
        
        if (confirmaciones.length >= CONFIG.confirmacionesRequeridas) {
            confirmarDeteccion(valor);
            confirmaciones = [];
        } else {
            mostrarParcial(valor, confirmaciones.length);
        }
    }
    
    function confirmarDeteccion(valor) {
        if (!valor || valor === 0) return;
        
        const colorInfo = CONFIG.coloresBilletes[valor] || { color: '#06b6d4', nombre: 'pesos' };
        
        ultimaDeteccion = Date.now();
        
        vibrar([100, 50, 100]);
        hablar(`Billete de ${colorInfo.nombre} pesos`);
        
        const panel = document.getElementById('panel-resultado');
        panel.classList.add('pulse-success');
        setTimeout(() => panel.classList.remove('pulse-success'), 500);
        
        document.getElementById('resultado-contenido').innerHTML = `
            <div class="resultado-flash">
                <div class="text-5xl font-bold mb-2" style="color: ${colorInfo.color}">
                    $${valor}
                </div>
                <p class="text-green-400 font-bold text-lg">‚úì CONFIRMADO</p>
            </div>
        `;
        
        agregarHistorial(valor);
        totalAcumulado += valor;
        document.getElementById('total').textContent = '$' + totalAcumulado.toLocaleString();
    }
    
    function mostrarParcial(valor, cuenta) {
        const colorInfo = CONFIG.coloresBilletes[valor] || { color: '#06b6d4' };
        
        document.getElementById('resultado-contenido').innerHTML = `
            <div class="text-4xl font-bold mb-2 opacity-70" style="color: ${colorInfo.color}">
                $${valor}?
            </div>
            <p class="text-amber-400">‚è≥ Verificando... (${cuenta}/${CONFIG.confirmacionesRequeridas})</p>
        `;
    }
    
    // ============================================
    // CONTROLES
    // ============================================
    async function toggleFlash() {
        if (!esp32Ip) return;
        
        flashEncendido = !flashEncendido;
        const endpoint = flashEncendido ? 'on' : 'off';
        
        // Usar imagen para hacer la solicitud (evita CORS)
        const img = new Image();
        img.src = `http://${esp32Ip}/flash/${endpoint}?t=${Date.now()}`;
        
        document.getElementById('btn-flash').textContent = flashEncendido ? 'üí° Flash ON' : 'üí° Flash OFF';
    }
    
    function toggleModoAuto() {
        modoAutoActivo = !modoAutoActivo;
        const btn = document.getElementById('btn-auto');
        
        if (modoAutoActivo) {
            btn.textContent = 'ON';
            btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm';
            hablar('Modo autom√°tico activado');
            
            intervaloAuto = setInterval(() => {
                if (!analizando) {
                    capturarYAnalizar();
                }
            }, CONFIG.intervaloAuto);
        } else {
            btn.textContent = 'OFF';
            btn.className = 'px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm';
            hablar('Modo autom√°tico desactivado');
            
            if (intervaloAuto) {
                clearInterval(intervaloAuto);
                intervaloAuto = null;
            }
        }
    }
    
    function toggleAudio() {
        audioHabilitado = !audioHabilitado;
        const btn = document.getElementById('btn-audio');
        btn.textContent = audioHabilitado ? 'üîä Audio ON' : 'üîá Audio OFF';
        btn.className = audioHabilitado 
            ? 'flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold'
            : 'flex-1 py-3 bg-slate-600 hover:bg-slate-500 rounded-xl font-bold';
    }
    
    // ============================================
    // AUDIO Y VIBRACI√ìN
    // ============================================
    function hablar(texto) {
        if (!audioHabilitado) return;
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'es-MX';
        utterance.rate = 1.0;
        speechSynthesis.speak(utterance);
    }
    
    function vibrar(patron = [100]) {
        if (navigator.vibrate) navigator.vibrate(patron);
    }
    
    // ============================================
    // HISTORIAL
    // ============================================
    function agregarHistorial(valor) {
        const hora = new Date().toLocaleTimeString('es-MX', { 
            hour: '2-digit', minute: '2-digit' 
        });
        
        historial.unshift({ valor, hora });
        if (historial.length > 5) historial.pop();
        
        document.getElementById('historial').innerHTML = historial.map(item => `
            <div class="flex justify-between text-xs">
                <span class="text-emerald-400 font-bold">$${item.valor}</span>
                <span class="text-slate-500">${item.hora}</span>
            </div>
        `).join('');
    }
    
    function resetTotal() {
        totalAcumulado = 0;
        historial = [];
        document.getElementById('total').textContent = '$0';
        document.getElementById('historial').innerHTML = '<p class="text-slate-600 text-xs">Sin detecciones</p>';
        hablar('Historial limpiado');
    }
    </script>
    
</body>
</html>
